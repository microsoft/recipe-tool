{
  "steps": [
    {
      "type": "set_context",
      "config": {
        "key": "output_dir",
        "value": "{{ output_dir | default: 'output' }}"
      }
    },
    {
      "type": "set_context",
      "config": {
        "key": "description",
        "value": "{{ description | default: 'Create a comprehensive document outline' }}"
      }
    },
    {
      "type": "set_context",
      "config": {
        "key": "resources",
        "value": "{{ resources | default: '' }}"
      }
    },
    {
      "type": "set_context",
      "config": {
        "key": "resource_summaries",
        "value": []
      }
    },
    {
      "type": "set_context",
      "config": {
        "key": "has_resources",
        "value": "{% if resources %}true{% else %}false{% endif %}"
      }
    },
    {
      "type": "conditional",
      "config": {
        "condition": "{{ has_resources }}",
        "if_true": {
          "steps": [
            {
              "type": "read_files",
              "config": {
                "path": "{{ resources }}",
                "content_key": "raw_resources",
                "optional": true,
                "merge_mode": "dict"
              }
            },
            {
              "type": "llm_generate",
              "config": {
                "prompt": "Summarize each of the following resources into a JSON list of objects with keys 'resource' (the filename) and 'summary' (a brief summary):\n\n{{ raw_resources | json }}",
                "model": "openai/gpt-4o",
                "output_format": [
                  {
                    "type": "object",
                    "properties": {
                      "resource": {"type": "string"},
                      "summary": {"type": "string"}
                    },
                    "required": ["resource", "summary"]
                  }
                ],
                "output_key": "resource_summaries"
              }
            }
          ]
        }
      }
    },
    {
      "type": "llm_generate",
      "config": {
        "prompt": "Generate a detailed outline in JSON format based on the user description and resource summaries:\n\nUser description:\n{{ description }}\n\nResource summaries:\n{{ resource_summaries | json }}\n\nThe outline must follow this exact JSON structure:\n{\n  \"title\": \"Document Title\",\n  \"general_instruction\": \"Overall instructions for document generation\",\n  \"resources\": [\n    {\n      \"key\": \"resource_1\",\n      \"path\": \"path/to/file\",\n      \"title\": \"filename\",\n      \"description\": \"description of what this resource contains\"\n    }\n  ],\n  \"sections\": [\n    {\n      \"title\": \"Section Title\",\n      \"prompt\": \"Instructions for generating this section's content\",\n      \"sections\": [],  // nested subsections if needed\n      \"refs\": [\"resource_1\", \"resource_2\"]  // array of resource keys\n    }\n  ]\n}\n\nIMPORTANT:\n- Each section must have: title, prompt, sections (can be empty array), and refs\n- The \"prompt\" field contains instructions for generating that section's content\n- The \"refs\" field is an array of resource keys (not full objects)\n- Sections can be nested by placing subsections in the \"sections\" array\n- Resource keys should match between the resources array and the refs arrays\n\nReturn only the JSON object.",
        "model": "openai/gpt-4o",
        "output_format": {
          "type": "object",
          "properties": {
            "title": {"type": "string"},
            "general_instruction": {"type": "string"},
            "resources": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "key": {"type": "string"},
                  "path": {"type": "string"},
                  "title": {"type": "string"},
                  "description": {"type": "string"}
                },
                "required": ["key", "path", "title", "description"]
              }
            },
            "sections": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "title": {"type": "string"},
                  "prompt": {"type": "string"},
                  "sections": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "title": {"type": "string"},
                        "prompt": {"type": "string"},
                        "sections": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "title": {"type": "string"},
                              "prompt": {"type": "string"},
                              "sections": {
                                "type": "array",
                                "items": {
                                  "type": "object",
                                  "properties": {
                                    "title": {"type": "string"},
                                    "prompt": {"type": "string"},
                                    "sections": {"type": "array", "items": {"type": "object"}},
                                    "refs": {
                                      "type": "array",
                                      "items": {"type": "string"}
                                    }
                                  },
                                  "required": ["title", "prompt", "sections", "refs"]
                                }
                              },
                              "refs": {
                                "type": "array",
                                "items": {"type": "string"}
                              }
                            },
                            "required": ["title", "prompt", "sections", "refs"]
                          }
                        },
                        "refs": {
                          "type": "array",
                          "items": {"type": "string"}
                        }
                      },
                      "required": ["title", "prompt", "sections", "refs"]
                    }
                  },
                  "refs": {
                    "type": "array",
                    "items": {"type": "string"}
                  }
                },
                "required": ["title", "prompt", "sections", "refs"]
              }
            }
          },
          "required": ["title", "general_instruction", "resources", "sections"]
        },
        "output_key": "outline"
      }
    },
    {
      "type": "write_files",
      "config": {
        "files": [
          {
            "path": "outline.json",
            "content_key": "outline"
          }
        ],
        "root": "{{ output_dir }}"
      }
    }
  ]
}